<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BookingController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Hotel Booking System</a> &gt; <a href="index.source.html" class="el_package">com.hotel.controller</a> &gt; <span class="el_source">BookingController.java</span></div><h1>BookingController.java</h1><pre class="source lang-java linenums">package com.hotel.controller;

import com.hotel.model.Booking;
import com.hotel.model.User;
import com.hotel.service.BookingService;
import com.hotel.service.HotelService;
import com.hotel.service.RoomService;
import com.hotel.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.format.annotation.DateTimeFormat;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import javax.servlet.http.HttpSession;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.time.temporal.ChronoUnit;
import java.util.Optional;

@Controller
@RequestMapping(&quot;/bookings&quot;)
<span class="fc" id="L24">public class BookingController {</span>
    
    @Autowired
    private BookingService bookingService;
    
    @Autowired
    private HotelService hotelService;
    
    @Autowired
    private RoomService roomService;
    
    @Autowired
    private UserService userService;
    
    @GetMapping(&quot;/new/{roomId}&quot;)
    public String showBookingForm(@PathVariable Long roomId, 
                                 @RequestParam(required = false) Long hotelId,
                                 Model model, HttpSession session) {
<span class="nc" id="L42">        Long userId = (Long) session.getAttribute(&quot;userId&quot;);</span>
<span class="nc bnc" id="L43" title="All 2 branches missed.">        if (userId == null) {</span>
<span class="nc" id="L44">            return &quot;redirect:/auth/login&quot;;</span>
        }
        
<span class="nc" id="L47">        roomService.getRoomById(roomId).ifPresent(room -&gt; {</span>
<span class="nc" id="L48">            model.addAttribute(&quot;room&quot;, room);</span>
<span class="nc" id="L49">            model.addAttribute(&quot;hotel&quot;, room.getHotel());</span>
<span class="nc" id="L50">        });</span>
        
<span class="nc" id="L52">        Booking booking = new Booking();</span>
<span class="nc" id="L53">        booking.setCheckInDate(LocalDate.now().plusDays(1));</span>
<span class="nc" id="L54">        booking.setCheckOutDate(LocalDate.now().plusDays(2));</span>
<span class="nc" id="L55">        booking.setGuests(1);</span>
        
<span class="nc" id="L57">        model.addAttribute(&quot;booking&quot;, booking);</span>
        
        // Format dates for HTML input
<span class="nc" id="L60">        DateTimeFormatter formatter = DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd&quot;);</span>
<span class="nc" id="L61">        model.addAttribute(&quot;minDate&quot;, LocalDate.now().plusDays(1).format(formatter));</span>
<span class="nc" id="L62">        model.addAttribute(&quot;checkInDate&quot;, booking.getCheckInDate().format(formatter));</span>
<span class="nc" id="L63">        model.addAttribute(&quot;checkOutDate&quot;, booking.getCheckOutDate().format(formatter));</span>
        
<span class="nc" id="L65">        Optional&lt;User&gt; userOpt = userService.findById(userId);</span>
<span class="nc" id="L66">        userOpt.ifPresent(user -&gt; model.addAttribute(&quot;currentUser&quot;, user));</span>
        
<span class="nc" id="L68">        return &quot;booking-form&quot;;</span>
    }
    
    @PostMapping(&quot;/create&quot;)
    public String createBooking(@RequestParam Long roomId,
                              @RequestParam Long hotelId,
                              @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate checkInDate,
                              @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate checkOutDate,
                              @RequestParam Integer guests,
                              @RequestParam(required = false) String specialRequests,
                              HttpSession session,
                              RedirectAttributes redirectAttributes) {
<span class="nc" id="L80">        Long userId = (Long) session.getAttribute(&quot;userId&quot;);</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">        if (userId == null) {</span>
<span class="nc" id="L82">            return &quot;redirect:/auth/login&quot;;</span>
        }
        
        try {
<span class="nc" id="L86">            Optional&lt;User&gt; userOpt = userService.findById(userId);</span>
<span class="nc" id="L87">            Optional&lt;com.hotel.model.Room&gt; roomOpt = roomService.getRoomById(roomId);</span>
<span class="nc" id="L88">            Optional&lt;com.hotel.model.Hotel&gt; hotelOpt = hotelService.getHotelById(hotelId);</span>
            
<span class="nc bnc" id="L90" title="All 6 branches missed.">            if (userOpt.isPresent() &amp;&amp; roomOpt.isPresent() &amp;&amp; hotelOpt.isPresent()) {</span>
                // Create booking object
<span class="nc" id="L92">                Booking booking = new Booking();</span>
<span class="nc" id="L93">                booking.setCheckInDate(checkInDate);</span>
<span class="nc" id="L94">                booking.setCheckOutDate(checkOutDate);</span>
<span class="nc" id="L95">                booking.setGuests(guests);</span>
<span class="nc" id="L96">                booking.setSpecialRequests(specialRequests);</span>
<span class="nc" id="L97">                booking.setUser(userOpt.get());</span>
<span class="nc" id="L98">                booking.setRoom(roomOpt.get());</span>
<span class="nc" id="L99">                booking.setHotel(hotelOpt.get());</span>
                
                // Validate dates
<span class="nc bnc" id="L102" title="All 2 branches missed.">                if (checkInDate.isBefore(LocalDate.now())) {</span>
<span class="nc" id="L103">                    redirectAttributes.addFlashAttribute(&quot;error&quot;, &quot;Check-in date cannot be in the past&quot;);</span>
<span class="nc" id="L104">                    return &quot;redirect:/bookings/new/&quot; + roomId + &quot;?hotelId=&quot; + hotelId;</span>
                }
                
<span class="nc bnc" id="L107" title="All 4 branches missed.">                if (checkOutDate.isBefore(checkInDate) || checkOutDate.isEqual(checkInDate)) {</span>
<span class="nc" id="L108">                    redirectAttributes.addFlashAttribute(&quot;error&quot;, &quot;Check-out date must be after check-in date&quot;);</span>
<span class="nc" id="L109">                    return &quot;redirect:/bookings/new/&quot; + roomId + &quot;?hotelId=&quot; + hotelId;</span>
                }
                
                // Check room availability
<span class="nc bnc" id="L113" title="All 2 branches missed.">                if (!bookingService.isRoomAvailable(roomId, booking.getCheckInDate(), booking.getCheckOutDate())) {</span>
<span class="nc" id="L114">                    redirectAttributes.addFlashAttribute(&quot;error&quot;, &quot;Room is not available for the selected dates&quot;);</span>
<span class="nc" id="L115">                    return &quot;redirect:/bookings/new/&quot; + roomId + &quot;?hotelId=&quot; + hotelId;</span>
                }
                
<span class="nc" id="L118">                Booking savedBooking = bookingService.createBooking(booking);</span>
<span class="nc" id="L119">                redirectAttributes.addFlashAttribute(&quot;success&quot;, &quot;Booking confirmed successfully!&quot;);</span>
<span class="nc" id="L120">                return &quot;redirect:/bookings/confirmation/&quot; + savedBooking.getId();</span>
            } else {
<span class="nc" id="L122">                redirectAttributes.addFlashAttribute(&quot;error&quot;, &quot;Invalid booking details&quot;);</span>
<span class="nc" id="L123">                return &quot;redirect:/hotels&quot;;</span>
            }
<span class="nc" id="L125">        } catch (Exception e) {</span>
<span class="nc" id="L126">            redirectAttributes.addFlashAttribute(&quot;error&quot;, &quot;Error creating booking: &quot; + e.getMessage());</span>
<span class="nc" id="L127">            return &quot;redirect:/bookings/new/&quot; + roomId + &quot;?hotelId=&quot; + hotelId;</span>
        }
    }
    
    @GetMapping(&quot;/confirmation/{id}&quot;)
    public String bookingConfirmation(@PathVariable Long id, Model model, HttpSession session) {
<span class="nc" id="L133">        Long userId = (Long) session.getAttribute(&quot;userId&quot;);</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">        if (userId == null) {</span>
<span class="nc" id="L135">            return &quot;redirect:/auth/login&quot;;</span>
        }
        
<span class="nc" id="L138">        bookingService.getBookingById(id).ifPresent(booking -&gt; {</span>
<span class="nc" id="L139">            model.addAttribute(&quot;booking&quot;, booking);</span>
            
            // Calculate duration
<span class="nc" id="L142">            long nights = ChronoUnit.DAYS.between(booking.getCheckInDate(), booking.getCheckOutDate());</span>
<span class="nc" id="L143">            model.addAttribute(&quot;bookingDuration&quot;, nights);</span>
<span class="nc" id="L144">        });</span>
        
<span class="nc" id="L146">        Optional&lt;User&gt; userOpt = userService.findById(userId);</span>
<span class="nc" id="L147">        userOpt.ifPresent(user -&gt; model.addAttribute(&quot;currentUser&quot;, user));</span>
        
<span class="nc" id="L149">        return &quot;booking-confirmation&quot;;</span>
    }
    
    @GetMapping(&quot;/my-bookings&quot;)
    public String getMyBookings(Model model, HttpSession session) {
<span class="nc" id="L154">        Long userId = (Long) session.getAttribute(&quot;userId&quot;);</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">        if (userId == null) {</span>
<span class="nc" id="L156">            return &quot;redirect:/auth/login&quot;;</span>
        }
        
<span class="nc" id="L159">        model.addAttribute(&quot;bookings&quot;, bookingService.getBookingsByUserId(userId));</span>
        
<span class="nc" id="L161">        Optional&lt;User&gt; userOpt = userService.findById(userId);</span>
<span class="nc" id="L162">        userOpt.ifPresent(user -&gt; model.addAttribute(&quot;currentUser&quot;, user));</span>
        
<span class="nc" id="L164">        return &quot;my-bookings&quot;;</span>
    }
    
    @PostMapping(&quot;/cancel/{id}&quot;)
    public String cancelBooking(@PathVariable Long id, HttpSession session, RedirectAttributes redirectAttributes) {
<span class="nc" id="L169">        Long userId = (Long) session.getAttribute(&quot;userId&quot;);</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">        if (userId == null) {</span>
<span class="nc" id="L171">            return &quot;redirect:/auth/login&quot;;</span>
        }
        
        try {
<span class="nc" id="L175">            bookingService.cancelBooking(id);</span>
<span class="nc" id="L176">            redirectAttributes.addFlashAttribute(&quot;success&quot;, &quot;Booking cancelled successfully&quot;);</span>
<span class="nc" id="L177">        } catch (Exception e) {</span>
<span class="nc" id="L178">            redirectAttributes.addFlashAttribute(&quot;error&quot;, &quot;Error cancelling booking&quot;);</span>
<span class="nc" id="L179">        }</span>
        
<span class="nc" id="L181">        return &quot;redirect:/bookings/my-bookings&quot;;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>